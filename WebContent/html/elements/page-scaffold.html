<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/core-ajax/core-ajax.html">
<link rel="import" href="../bower_components/google-map/google-map.html">

<polymer-element name="page-scaffold">
    <template>
        <style>
            google-map {
                display: block;
                height: 100%;
            }
            .departures {
                -webkit-animation: openDrawer 0.33s forwards;
            }
            @-webkit-keyframes openDrawer {
                from {
                    margin-left: 0
                }
                to {
                    margin-left: 200px;
                }
            }
        </style>
        <template if="{{stops}}">
            <google-map latitude="[[lat]]" longitude="[[lon]]" disableDefaultUI zoom="16" on-center-change="{{centerChange}}" class="{{showDepartures ? 'departures' : ''}}">
                <template repeat="{{stop in stops}}">
                    <google-map-marker stopId="{{stop.id}}" on-marker-clicked="{{markerClicked}}" latitude="{{stop.lat}}" longitude="{{stop.lon}}" title="{{stop.name}}, {{stop.street}}"></google-map-marker>
                </template>
            </google-map>
        </template>

        <core-ajax id="ajaxNearbyStops" url="http://81.158.41.149:8080/UKBus/rest/stops/search?lat={{lat}}&lon={{lon}}"
                   on-core-response="{{nearbyStopsLoaded}}" handleAs="json"></core-ajax>


    </template>
    <script>
        Polymer({
            domReady: function() {
                navigator.geolocation.getCurrentPosition(this.positionLoaded.bind(this));
            },

            positionLoaded: function(position) {
                console.log("position determined");
                this.lat = position.coords.latitude;
                this.lon = position.coords.longitude;

                this.$.ajaxNearbyStops.go();
            },

            nearbyStopsLoaded: function(e, detail) {
                this.stops = detail.response;
            },

            centerChange: function(e, detail){
                this.lat = detail.latitude;
                this.lon = detail.longitude;

                this.$.ajaxNearbyStops.go();
            },

            markerClicked: function() {
                console.log('marker-clicked');
                this.showDepartures = true;
            }
        })
    </script>
</polymer-element>